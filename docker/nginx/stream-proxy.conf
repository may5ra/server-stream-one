worker_processes auto;

events {
    worker_connections 4096;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;
    
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    
    # Proxy cache for HLS segments
    proxy_cache_path /tmp/stream-cache levels=1:2 keys_zone=stream_cache:100m max_size=10g inactive=10m use_temp_path=off;
    
    # Upstream timeout settings
    proxy_connect_timeout 10s;
    proxy_read_timeout 30s;
    proxy_send_timeout 30s;
    
    # Buffer settings for streaming
    proxy_buffering on;
    proxy_buffer_size 128k;
    proxy_buffers 8 256k;
    proxy_busy_buffers_size 512k;
    
    # Resolver for dynamic proxy_pass
    resolver 8.8.8.8 8.8.4.4 valid=300s;
    resolver_timeout 5s;
    
    # Lua shared dict for stream URLs
    lua_shared_dict stream_urls 10m;
    
    server {
        listen 8888;
        
        # CORS headers
        add_header Access-Control-Allow-Origin * always;
        add_header Access-Control-Allow-Methods 'GET, OPTIONS' always;
        add_header Access-Control-Allow-Headers '*' always;
        
        # Handle preflight
        if ($request_method = 'OPTIONS') {
            return 204;
        }
        
        # Health check
        location /health {
            return 200 'OK';
            add_header Content-Type text/plain;
        }
        
        # Stream proxy - pattern: /stream/{base64_encoded_url}
        location ~ ^/stream/(.+) {
            set $encoded_url $1;
            
            # Decode base64 URL
            set_by_lua_block $target_url {
                local encoded = ngx.var.encoded_url
                -- URL decode first
                encoded = ngx.unescape_uri(encoded)
                -- Base64 decode
                local decoded = ngx.decode_base64(encoded)
                if decoded then
                    return decoded
                end
                return nil
            }
            
            if ($target_url = '') {
                return 400 'Invalid stream URL';
            }
            
            # Direct proxy pass - no URL rewriting
            proxy_pass $target_url;
            proxy_http_version 1.1;
            proxy_set_header Host $proxy_host;
            proxy_set_header User-Agent 'VLC/3.0.20 LibVLC/3.0.20';
            proxy_set_header Accept '*/*';
            proxy_set_header Connection '';
            
            # Follow redirects
            proxy_intercept_errors off;
            
            # Cache for segments
            proxy_cache stream_cache;
            proxy_cache_key $target_url;
            proxy_cache_valid 200 302 5m;
            proxy_cache_valid 404 1s;
            proxy_cache_use_stale error timeout updating;
            
            # Don't cache manifests (they update frequently)
            set $no_cache 0;
            if ($target_url ~* "\.m3u8") {
                set $no_cache 1;
            }
            proxy_cache_bypass $no_cache;
            proxy_no_cache $no_cache;
        }
        
        # Direct proxy for known patterns
        # Pattern: /proxy/{stream_id}/{path}
        location ~ ^/proxy/([^/]+)/(.+)$ {
            internal;
            set $stream_id $1;
            set $stream_path $2;
            
            # Get target from Lua
            set_by_lua_block $target {
                local stream_urls = ngx.shared.stream_urls
                local base = stream_urls:get(ngx.var.stream_id)
                if base then
                    return base .. ngx.var.stream_path
                end
                return nil
            }
            
            if ($target = '') {
                return 404;
            }
            
            proxy_pass $target;
            proxy_http_version 1.1;
            proxy_set_header Host $proxy_host;
            proxy_set_header User-Agent 'VLC/3.0.20';
        }
    }
}
